<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>üöÄ Deploy your app | A Workshop all about GraphQL</title>
    <meta name="description" content="">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.1c371215.css" as="style"><link rel="preload" href="/assets/js/app.6a44516b.js" as="script"><link rel="preload" href="/assets/js/2.f8dac7df.js" as="script"><link rel="preload" href="/assets/js/11.411e1f26.js" as="script"><link rel="prefetch" href="/assets/js/10.48e34d08.js"><link rel="prefetch" href="/assets/js/12.fbc0515a.js"><link rel="prefetch" href="/assets/js/13.be970c90.js"><link rel="prefetch" href="/assets/js/3.295021d7.js"><link rel="prefetch" href="/assets/js/4.dadc6ac6.js"><link rel="prefetch" href="/assets/js/5.846d5356.js"><link rel="prefetch" href="/assets/js/6.403a7329.js"><link rel="prefetch" href="/assets/js/7.a44b5c1a.js"><link rel="prefetch" href="/assets/js/8.e6c64800.js"><link rel="prefetch" href="/assets/js/9.1eef7885.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1c371215.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">A Workshop all about GraphQL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/workshop/1.html" class="sidebar-link">üçïIntroduction - What is GraphQL and Serverless?</a></li><li><a href="/workshop/2.html" class="sidebar-link">üîé The GraphQL API</a></li><li><a href="/workshop/3.html" class="sidebar-link">üì¶ Microservices and Docker</a></li><li><a href="/workshop/4.html" class="sidebar-link">‚òÅÔ∏è Serverless Functions</a></li><li><a href="/workshop/5.html" class="active sidebar-link">üöÄ Deploy your app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/workshop/5.html#what-we-will-build" class="sidebar-link">What we will build</a></li><li class="sidebar-sub-header"><a href="/workshop/5.html#solution" class="sidebar-link">Solution</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="üöÄ-deploy-your-app"><a href="#üöÄ-deploy-your-app" aria-hidden="true" class="header-anchor">#</a> üöÄ Deploy your app</h1> <h2 id="what-we-will-build"><a href="#what-we-will-build" aria-hidden="true" class="header-anchor">#</a> What we will build</h2> <p>There are two things we need to deploy:</p> <ol><li><strong>Our microservices</strong>, to deploy those we need to upload them to a container registry. Once they are in the container registry then we can create service endpoints</li> <li><strong>Our serverless API</strong>, this is as simple to do as using VS Code and upload it by a mere click.</li></ol> <h3 id="micro-services-prerequisites"><a href="#micro-services-prerequisites" aria-hidden="true" class="header-anchor">#</a> Micro services prerequisites</h3> <p>To do this part we need the Azure CLI installed:</p> <div class="language- extra-class"><pre class="language-text"><code>https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest&amp;
</code></pre></div><p>As we mentioned above there are two steps we need to take for each service:</p> <ul><li><strong>Upload</strong> to container registry</li> <li><strong>Create</strong> a service endpoint</li></ul> <p><strong>Create resource group</strong>
Let's create a Resource Group first:</p> <div class="language- extra-class"><pre class="language-text"><code>az group create --name [name of resource group] --location westeurope
</code></pre></div><p><strong>Create container registry</strong></p> <p>After that we need to create a <em>container registry</em></p> <div class="language- extra-class"><pre class="language-text"><code>az acr create --resource-group [name of resource group] --name [name of container registry, unique and only a-z or 0-9] --sku Basic --admin-enabled true
</code></pre></div><h3 id="build-tag-push-container-create-endpoint"><a href="#build-tag-push-container-create-endpoint" aria-hidden="true" class="header-anchor">#</a> Build, tag, push container + create endpoint</h3> <p>We need to do these steps for product service and reviews service.</p> <p><strong>Build image</strong></p> <p>Let's first build our service:</p> <div class="language- extra-class"><pre class="language-text"><code>docker build -t products-service .
</code></pre></div><p><strong>Find login server value</strong></p> <p>Next, we need to find out the <code>login server</code>. That's a two-step process</p> <p>First login to our container registry:</p> <div class="language- extra-class"><pre class="language-text"><code>az acr login --name [name of registry]
</code></pre></div><p>Now query for the login server name with:</p> <div class="language- extra-class"><pre class="language-text"><code>az acr show --name [name of container registry] --query loginServer --output table
</code></pre></div><p><strong>Tag image</strong></p> <p>Let's now use the value of <em>login server</em></p> <div class="language- extra-class"><pre class="language-text"><code>docker tag products-service [loginServer]/products-service:v1
</code></pre></div><p><strong>Push our image to the registry</strong></p> <div class="language- extra-class"><pre class="language-text"><code>docker push [loginServer]/products-service:v1
</code></pre></div><p>Verify the push did its job with the following command:</p> <div class="language- extra-class"><pre class="language-text"><code>az acr repository list --name [name of registry] --output table
</code></pre></div><p><strong>Create a service endpoint</strong></p> <p>There are two ways of doing this, either:</p> <ol><li>Azure CLI</li> <li>Visually through the portal</li></ol> <p><strong>Alt I - Azure CLI  - create endpoint</strong></p> <p>Before we can create our endpoint we need the values for username and password, like so:</p> <div class="language- extra-class"><pre class="language-text"><code>az acr credential show --name --query &quot;passwords[0].value&quot;
</code></pre></div><p>Now let's create a container in the Cloud from our pushed image:</p> <div class="language- extra-class"><pre class="language-text"><code>az container create --resource-group [resource group] --name aci-tutorial-app --image &lt;acrLoginServer&gt;/[products-service or reviews-service]] --cpu 1 --memory 1 --registry-login-server [acrLoginServer] --registry-username [acrName] --registry-password [acrPassword] --dns-name-label [aciDnsLabel] --ports 80
</code></pre></div><p><strong>ALT II - Visually create endpoint</strong></p> <p>To do this visually, we need to open up the portal and select to create a resource, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/m3u7ox70e1hnfcvfl269.png" alt=""></p> <p>Next select the correct template by typing <code>Web App for Containers</code>:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/tbho3zfew4auk5789dot.png" alt=""></p> <p>Thereafter fill in some mandatory fields:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/hv4tjrud8dhybgav21ld.png" alt=""></p> <p>Click the <code>Configure Container</code> section and select the correct container registry and the correct container (that you just created and uploaded).</p> <p>That's it, that should create the endpoint..</p> <h3 id="serverless-api"><a href="#serverless-api" aria-hidden="true" class="header-anchor">#</a> Serverless API</h3> <p>So how do we deploy the Serverless API?</p> <p>We need to revisit our Serverless app before we can deploy, why is that?</p> <p>Right now the external endpoints in it are pointing to local IP addresses.</p> <p>Looking at the file <code>Query.cs</code> we see this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">GraphQLMetadata</span><span class="token punctuation">(</span><span class="token string">&quot;reviews&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Review<span class="token operator">&gt;&gt;</span> <span class="token function">GetReviews</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> HttpHelper<span class="token punctuation">.</span>Get<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Review<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token class-name">GraphQLMetadata</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;&gt;</span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span>  <span class="token keyword">await</span> HttpHelper<span class="token punctuation">.</span>Get<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Both these should point to our new endpoints in Azure. To make that possible we change the above to:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">GraphQLMetadata</span><span class="token punctuation">(</span><span class="token string">&quot;reviews&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Review<span class="token operator">&gt;&gt;</span> <span class="token function">GetReviews</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> HttpHelper<span class="token punctuation">.</span>Get<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Review<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;REVIEWS_URL&quot;</span><span class="token punctuation">,</span> EnvironmentVariableTarget<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token class-name">GraphQLMetadata</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;&gt;</span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span>  <span class="token keyword">await</span> HttpHelper<span class="token punctuation">.</span>Get<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;PRODUCTS_URL&quot;</span><span class="token punctuation">,</span> EnvironmentVariableTarget<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now, when our function app is deployed to the Cloud it will read from it's AppSettings and populate <code>process.env</code>.</p> <blockquote><p>How do we get the above values to AppSettings?</p></blockquote> <p>There are two ways</p> <ol><li><strong>Manually add an entry</strong> in the AppSettings in the portal for the Azure Function App once we deployed it</li> <li><strong>Store these values in the file <code>local.settings.json</code></strong> and as part of deploying our Azure App we select to copy values from this file to AppSettings</li></ol> <p>We will show the latter</p> <p><strong>Store app keys in local.settings.json</strong></p> <p>Looking at the contents of <code>local.settings.json</code> it should look something like this:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;IsEncrypted&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Values&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;AzureWebJobsStorage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;FUNCTIONS_WORKER_RUNTIME&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the <code>Values</code> property add the needed keys:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;IsEncrypted&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Values&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;AzureWebJobsStorage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;FUNCTIONS_WORKER_RUNTIME&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;PRODUCTS_URL&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;url to endpoint&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;REVIEWS_URL&quot;</span><span class="token operator">:</span><span class="token string">&quot;&lt;url to endpoint&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Deploy the Azure Function App</strong></p> <p>Click the Azure logo on the left toolbar in VS Code.</p> <p>Sign in to Azure if you haven't already done so.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/0485qfd86jawp4c9blx3.png" alt=""></p> <p>Click the deploy symbol</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/p07g5173lrpvuwuusvi0.png" alt=""></p> <p>Select to <code>Create a new Function App</code></p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/feovtte58st3x1l1byez.png" alt=""></p> <p>It should start showing something like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/sx350ke8d6u820s8kycn.png" alt=""></p> <p>When it's done it should say something like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/7nis5z0xk4fcyv2y6dnm.png" alt=""></p> <p><strong>Transfer app keys</strong></p> <p>Now that you have an Azure Function App, right click it and select <code>Upload Local Settings</code>.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/yw4d7m5d02nneh1a4ro3.png" alt=""></p> <p>Everything should be in the Cloud now and working !</p> <h2 id="solution"><a href="#solution" aria-hidden="true" class="header-anchor">#</a> Solution</h2> <p>TODO</p> <p><a href="https://github.com/softchris/graphql-workshop-dotnet/tree/master/part5" target="_blank" rel="noopener noreferrer">SOLUTION workshop part 5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/5/2020, 5:52:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê
        <a href="/workshop/4.html" class="prev">
          ‚òÅÔ∏è Serverless Functions
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6a44516b.js" defer></script><script src="/assets/js/2.f8dac7df.js" defer></script><script src="/assets/js/11.411e1f26.js" defer></script>
  </body>
</html>
